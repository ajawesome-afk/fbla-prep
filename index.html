<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FBLA Prep | Mastery Center</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & DOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Custom Styles & Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-font-smoothing: antialiased; 
        }
        
        /* Smooth Transitions */
        .theme-transition { transition: background-color 0.5s cubic-bezier(0.4, 0, 0.2, 1), color 0.5s cubic-bezier(0.4, 0, 0.2, 1), border-color 0.5s ease; }
        
        /* Keyframes */
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Classes */
        .animate-enter { animation: slideUpFade 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-float { animation: float 6s ease-in-out infinite; }
        
        .shimmer-bg {
            background: #f4f4f5;
            background-image: linear-gradient(to right, #f4f4f5 0%, #e4e4e7 20%, #f4f4f5 40%, #f4f4f5 100%);
            background-repeat: no-repeat;
            background-size: 2000px 100%; 
            animation: shimmer 1.5s infinite linear; 
        }
        
        .dark .shimmer-bg {
             background: #27272a;
             background-image: linear-gradient(to right, #27272a 0%, #3f3f46 20%, #27272a 40%, #27272a 100%);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #d4d4d8; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background-color: #3f3f46; }

        /* Gradients */
        .hover-gradient-dark:hover {
            background: linear-gradient(135deg, #18181b 0%, #27272a 100%);
        }
        .hover-gradient-light:hover {
            background: linear-gradient(135deg, #f4f4f5 0%, #ffffff 100%);
        }
    </style>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { 500: '#27272A', 600: '#18181B', 900: '#09090B' },
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-zinc-50 text-zinc-900 dark:bg-black dark:text-zinc-100 min-h-screen flex flex-col selection:bg-zinc-900 selection:text-white dark:selection:bg-white dark:selection:text-zinc-900 theme-transition overflow-x-hidden">
    <div id="root" class="flex-grow flex flex-col"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app, auth, db;
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase init error", e);
        }

        // Expose to window for React
        window.fb = {
            auth, 
            db, 
            signInWithPopup, 
            GoogleAuthProvider, 
            signOut, 
            onAuthStateChanged,
            signInAnonymously,
            signInWithCustomToken,
            collection,
            addDoc,
            query,
            orderBy,
            limit,
            onSnapshot,
            serverTimestamp,
            appId
        };
        
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Data ---
        const FBLA_TOPICS = [
            "Accounting", "Advertising", "Agribusiness", "Business Communication", "Business Law", 
            "Computer Problem Solving", "Cybersecurity", "Data Analysis", "Economics", 
            "Entrepreneurship", "Healthcare Administration", "Human Resource Management", 
            "Insurance & Risk Management", "Introduction to Business", "Introduction to IT", 
            "Journalism", "Marketing", "Networking Infrastructures", "Organizational Leadership", 
            "Personal Finance", "Project Management", "Public Speaking", 
            "Securities & Investments", "Sports & Entertainment Management", "Supply Chain Management", 
            "UX Design", "Website Design"
        ];

        // --- UI Components ---
        
        const Icon = ({ name, className = "", size = 20 }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    const iconElement = document.createElement('i');
                    iconElement.setAttribute('data-lucide', name);
                    iconElement.className = className;
                    iconRef.current.innerHTML = '';
                    iconRef.current.appendChild(iconElement);
                    window.lucide.createIcons({ root: iconRef.current });
                }
            }, [name, className]);
            return <span ref={iconRef} style={{ width: size, height: size, display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }}></span>;
        };

        const SplashScreen = ({ onComplete }) => {
            useEffect(() => {
                const timer = setTimeout(onComplete, 2200);
                return () => clearTimeout(timer);
            }, []);

            return (
                <div className="fixed inset-0 z-[100] bg-black flex items-center justify-center">
                    <div className="relative">
                        <div className="absolute inset-0 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 blur-3xl opacity-20 animate-pulse"></div>
                        <div className="relative z-10 flex flex-col items-center animate-enter">
                            <div className="w-20 h-20 bg-white rounded-2xl flex items-center justify-center mb-6 shadow-2xl shadow-white/10 animate-float">
                                <Icon name="zap" size={40} className="text-black fill-black" />
                            </div>
                            <h1 className="text-4xl font-bold text-white tracking-tighter mb-2">FBLA PREP</h1>
                            <div className="h-1 w-0 bg-white/50 rounded-full animate-[width_1s_ease-out_forwards_0.5s]" style={{animationName: 'growLine', animationFillMode: 'forwards'}}></div>
                            <style>{`@keyframes growLine { to { width: 100px; } }`}</style>
                        </div>
                    </div>
                </div>
            );
        };

        const SearchableSelect = ({ options, value, onChange, placeholder = "Select..." }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState("");
            const wrapperRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) setIsOpen(false);
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            useEffect(() => { if(value) setSearchTerm(value); }, [value]);

            const filteredOptions = options.filter(opt => opt.toLowerCase().includes(searchTerm.toLowerCase()));

            return (
                <div className="relative" ref={wrapperRef}>
                    <div className="relative group">
                        <input
                            type="text"
                            value={searchTerm}
                            onChange={(e) => {
                                setSearchTerm(e.target.value);
                                setIsOpen(true);
                                if(e.target.value === "") onChange("");
                            }}
                            onFocus={() => setIsOpen(true)}
                            placeholder={placeholder}
                            className="w-full p-4 pl-12 bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl outline-none focus:ring-2 focus:ring-zinc-900 dark:focus:ring-zinc-600 transition-all font-medium text-lg placeholder:text-zinc-400 dark:text-zinc-100 dark:placeholder:text-zinc-600"
                        />
                        <div className="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-400 pointer-events-none"><Icon name="search" size={20} /></div>
                        <div className="absolute right-4 top-1/2 -translate-y-1/2 text-zinc-400 cursor-pointer hover:text-zinc-600 dark:hover:text-zinc-200" onClick={() => setIsOpen(!isOpen)}>
                            <Icon name={isOpen ? "chevron-up" : "chevron-down"} size={20} />
                        </div>
                    </div>
                    {isOpen && (
                        <div className="absolute z-50 w-full mt-2 bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl shadow-xl max-h-60 overflow-y-auto overflow-hidden animate-enter">
                            {filteredOptions.length > 0 ? (
                                filteredOptions.map((opt) => (
                                    <div
                                        key={opt}
                                        onClick={() => { onChange(opt); setSearchTerm(opt); setIsOpen(false); }}
                                        className="px-4 py-3 hover:bg-zinc-50 dark:hover:bg-zinc-800 cursor-pointer flex items-center justify-between group transition-colors"
                                    >
                                        <span className="text-zinc-700 dark:text-zinc-300 group-hover:text-zinc-900 dark:group-hover:text-white font-medium">{opt}</span>
                                        {value === opt && <Icon name="check" size={16} className="text-emerald-500" />}
                                    </div>
                                ))
                            ) : <div className="p-4 text-center text-zinc-400 text-sm">No topics found</div>}
                        </div>
                    )}
                </div>
            );
        };

        const Button = ({ children, onClick, variant = 'primary', className = "", disabled = false }) => {
            const base = "px-6 py-4 rounded-xl font-medium transition-all duration-300 flex items-center justify-center gap-2 active:scale-95 text-sm tracking-wide";
            const variants = {
                primary: "bg-gradient-to-br from-zinc-800 to-black dark:from-zinc-100 dark:to-zinc-300 text-white dark:text-black shadow-lg shadow-zinc-200 dark:shadow-zinc-900/50 hover:shadow-xl disabled:opacity-50 disabled:shadow-none disabled:cursor-not-allowed",
                secondary: "bg-white dark:bg-zinc-900 text-zinc-700 dark:text-zinc-300 border border-zinc-200 dark:border-zinc-800 hover:border-zinc-400 dark:hover:border-zinc-600 hover:bg-zinc-50 dark:hover:bg-zinc-800",
                ghost: "text-zinc-500 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-white hover:bg-zinc-100 dark:hover:bg-zinc-800"
            };
            return <button onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${className}`}>{children}</button>;
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative bg-white dark:bg-zinc-900 w-full max-w-md rounded-2xl p-6 shadow-2xl animate-enter border border-zinc-200 dark:border-zinc-800">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-zinc-900 dark:text-white">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-full"><Icon name="x" size={20} /></button>
                        </div>
                        {children}
                    </div>
                </div>
            );
        };

        const Sidebar = ({ isOpen, onClose, user, history, onLoadTopic }) => {
            return (
                <>
                    {isOpen && <div className="fixed inset-0 bg-black/20 backdrop-blur-sm z-40" onClick={onClose}></div>}
                    <div className={`fixed inset-y-0 right-0 w-80 bg-white dark:bg-zinc-950 border-l border-zinc-200 dark:border-zinc-800 z-50 transform transition-transform duration-300 ease-in-out ${isOpen ? 'translate-x-0' : 'translate-x-full'} shadow-2xl`}>
                        <div className="p-6 h-full flex flex-col">
                            <div className="flex justify-between items-center mb-8">
                                <h2 className="text-xl font-bold dark:text-white">Your History</h2>
                                <button onClick={onClose}><Icon name="x" size={24} className="text-zinc-400 hover:text-zinc-900 dark:hover:text-white" /></button>
                            </div>
                            
                            {!user || user.isAnonymous ? (
                                <div className="text-center py-10">
                                    <div className="w-16 h-16 bg-zinc-100 dark:bg-zinc-900 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="user" size={32} className="text-zinc-400" /></div>
                                    <p className="text-zinc-500 dark:text-zinc-400 mb-4 text-sm">You are in Guest Mode.</p>
                                    <p className="text-xs text-zinc-400">History saves locally for this session.</p>
                                </div>
                            ) : (
                                <div className="flex-1 overflow-y-auto space-y-4 pr-2">
                                    {history.length === 0 ? (
                                        <p className="text-zinc-500 text-center italic mt-10">No history yet.</p>
                                    ) : (
                                        history.map((item) => (
                                            <div key={item.id} className="p-4 rounded-xl border border-zinc-100 dark:border-zinc-900 bg-zinc-50 dark:bg-zinc-900/50 hover:border-zinc-300 dark:hover:border-zinc-700 transition-colors cursor-pointer" onClick={() => { onLoadTopic(item.topic); onClose(); }}>
                                                <div className="flex justify-between mb-2">
                                                    <span className="font-bold text-sm text-zinc-900 dark:text-white truncate max-w-[120px]">{item.topic}</span>
                                                    <span className={`text-xs font-bold px-2 py-0.5 rounded ${item.score >= 80 ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400' : 'bg-zinc-200 text-zinc-600 dark:bg-zinc-800 dark:text-zinc-400'}`}>{item.score}%</span>
                                                </div>
                                                <div className="text-xs text-zinc-400 flex items-center gap-2">
                                                    <Icon name="calendar" size={12} />
                                                    {item.date ? new Date(item.date.seconds * 1000).toLocaleDateString() : 'Just now'}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </>
            );
        };

        // --- Main App ---

        function App() {
            // State
            const [showSplash, setShowSplash] = useState(true);
            const [theme, setTheme] = useState('light');
            const [view, setView] = useState('landing');
            const [user, setUser] = useState(null);
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [feedbackOpen, setFeedbackOpen] = useState(false);
            const [feedbackText, setFeedbackText] = useState("");
            const [history, setHistory] = useState([]);
            const [toast, setToast] = useState(null);
            
            // Quiz Config & State
            const [config, setConfig] = useState({ topic: '', mode: 'practice', questionCount: 20, duration: 25 });
            const [quizData, setQuizData] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [answers, setAnswers] = useState({});
            const [timeLeft, setTimeLeft] = useState(0);
            const [isLoading, setIsLoading] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');
            const [showExplanation, setShowExplanation] = useState(false);

            const apiKey = ""; 

            // Show Toast Helper
            const showToast = (msg, type = 'info') => {
                setToast({ msg, type });
                setTimeout(() => setToast(null), 4000);
            };

            // Firebase Logic
            useEffect(() => {
                if (!window.fb) return;
                const { auth, db, collection, query, orderBy, limit, onSnapshot, appId, onAuthStateChanged, signInAnonymously, signInWithCustomToken } = window.fb;

                // Mandatory Auth Check for Environment
                const initAuth = async () => {
                     if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                         try {
                             await signInWithCustomToken(auth, __initial_auth_token);
                         } catch (e) {
                             console.warn("Custom token failed, falling back to anon", e);
                             await signInAnonymously(auth);
                         }
                     } else {
                         // Default to anonymous if no token
                         await signInAnonymously(auth);
                     }
                };
                initAuth();

                const unsubscribeAuth = onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        setUser(u);
                        // Subscribe to history
                        const q = query(collection(db, 'artifacts', appId, 'users', u.uid, 'history'), orderBy('date', 'desc'), limit(20));
                        const unsubHistory = onSnapshot(q, (snap) => {
                            setHistory(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                        }, (err) => console.log("History error", err));
                        return () => unsubHistory();
                    } else {
                        setUser(null);
                        setHistory([]);
                    }
                });

                return () => unsubscribeAuth();
            }, []);

            const handleLogin = async () => {
                if (!window.fb) return;
                const { auth, signInWithPopup, GoogleAuthProvider, signInAnonymously } = window.fb;
                try {
                    const provider = new GoogleAuthProvider();
                    await signInWithPopup(auth, provider);
                } catch (err) {
                    if (err.code === 'auth/unauthorized-domain') {
                        showToast("Preview Environment: Continued as Guest", 'info');
                    } else {
                        console.error("Auth Error", err);
                        showToast("Login failed. Continuing as Guest.", 'error');
                    }
                    // Ensure we have a session regardless
                    if (!auth.currentUser) await signInAnonymously(auth);
                }
            };

            const handleFeedbackSubmit = async () => {
                if (!feedbackText.trim() || !window.fb) return;
                const { db, collection, addDoc, serverTimestamp, appId } = window.fb;
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'feedback'), {
                        text: feedbackText,
                        userId: user ? user.uid : 'anon',
                        timestamp: serverTimestamp()
                    });
                    setFeedbackText("");
                    setFeedbackOpen(false);
                    showToast("Feedback sent successfully!");
                } catch (e) {
                    console.error("Feedback error", e);
                    showToast("Could not send feedback.", "error");
                }
            };

            const saveResult = async (score) => {
                 if (!user || !window.fb) return;
                 const { db, collection, addDoc, serverTimestamp, appId } = window.fb;
                 try {
                     await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'history'), {
                         topic: config.topic,
                         score: score,
                         total: quizData.length,
                         mode: config.mode,
                         date: serverTimestamp()
                     });
                 } catch (e) { console.error("Save error", e); }
            };

            // Theme toggle
            const toggleTheme = () => {
                const newTheme = theme === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
                if (newTheme === 'dark') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            };

            // Quiz Logic
            const generateQuiz = async () => {
                setIsLoading(true);
                setView('loading');
                setErrorMsg('');
                
                const fetchWithRetry = async (retries = 3, delay = 1000) => {
                    const systemPrompt = `Create a hard, competition-level practice test for FBLA "${config.topic}". Generate exactly ${config.questionCount} multiple choice questions. Return ONLY raw JSON. Schema: Array<{ question: string, options: string[], correctAnswerIndex: number, explanation: string }>`;
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: `Generate ${config.questionCount} FBLA ${config.topic} questions.` }] }],
                                systemInstruction: { parts: [{ text: systemPrompt }] },
                                generationConfig: { responseMimeType: "application/json" }
                            })
                        });
                        if (!response.ok) throw new Error("API Error");
                        const data = await response.json();
                        return JSON.parse(data.candidates[0].content.parts[0].text);
                    } catch (err) {
                        if (retries > 0) {
                            await new Promise(r => setTimeout(r, delay));
                            return fetchWithRetry(retries - 1, delay * 2);
                        }
                        throw err;
                    }
                };

                try {
                    const questions = await fetchWithRetry();
                    setQuizData(questions);
                    setCurrentIndex(0);
                    setAnswers({});
                    setShowExplanation(false);
                    if (config.mode === 'timed') setTimeLeft(config.duration * 60);
                    setTimeout(() => { setIsLoading(false); setView('testing'); }, 800);
                } catch (err) {
                    setIsLoading(false);
                    setErrorMsg("Please try a smaller number of questions or try again.");
                    setView('landing');
                }
            };

            useEffect(() => {
                let timer;
                if (view === 'testing' && config.mode === 'timed' && timeLeft > 0) {
                    timer = setInterval(() => setTimeLeft(prev => {
                        if (prev <= 1) { finishTest(); return 0; }
                        return prev - 1;
                    }), 1000);
                }
                return () => clearInterval(timer);
            }, [view, config.mode, timeLeft]);

            const finishTest = () => {
                setView('results');
                setShowExplanation(true);
                const correct = Object.keys(answers).filter(k => answers[k] === quizData[k].correctAnswerIndex).length;
                const score = Math.round((correct / quizData.length) * 100);
                saveResult(score);
            };

            const resetApp = () => {
                setView('landing');
                setQuizData([]);
                setAnswers({});
            };
            
            const formatTime = (s) => `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`;

            // --- Views ---

            if (showSplash) return <SplashScreen onComplete={() => setShowSplash(false)} />;

            const LandingView = () => (
                <div className="max-w-4xl mx-auto w-full px-6 pt-12 md:pt-20 animate-enter pb-32">
                    <div className="text-center mb-16">
                        <h1 className="text-5xl md:text-7xl font-bold tracking-tight text-zinc-900 dark:text-white mb-6">
                            Master your event.
                        </h1>
                        <p className="text-xl text-zinc-500 dark:text-zinc-400 max-w-lg mx-auto leading-relaxed font-light">
                            Configure your custom simulation environment.
                        </p>
                    </div>

                    <div className="grid md:grid-cols-12 gap-8">
                        <div className="md:col-start-3 md:col-span-8 bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-3xl p-8 shadow-xl shadow-zinc-200/50 dark:shadow-black/50 theme-transition">
                            {errorMsg && (
                                <div className="mb-6 p-4 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-sm rounded-xl border border-red-100 dark:border-red-900/30 flex items-center gap-3">
                                    <Icon name="alert-triangle" size={18} /> {errorMsg}
                                </div>
                            )}
                            
                            <div className="space-y-8">
                                <div className="space-y-3">
                                    <label className="block text-xs font-bold text-zinc-400 dark:text-zinc-500 uppercase tracking-widest ml-1">Topic</label>
                                    <SearchableSelect options={FBLA_TOPICS} value={config.topic} onChange={(val) => setConfig({...config, topic: val})} placeholder="Type topic (e.g. 'Network')..." />
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    {[{ id: 'practice', icon: 'zap', label: 'Practice' }, { id: 'timed', icon: 'clock', label: 'Ranked' }].map(m => (
                                        <button 
                                            key={m.id}
                                            onClick={() => setConfig({ ...config, mode: m.id })}
                                            className={`p-4 rounded-xl border text-left transition-all duration-200 group relative overflow-hidden ${
                                                config.mode === m.id 
                                                ? 'border-zinc-900 dark:border-zinc-100 bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 shadow-xl' 
                                                : 'border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-900 text-zinc-600 dark:text-zinc-400 hover:border-zinc-300 dark:hover:border-zinc-700'
                                            }`}
                                        >
                                            <div className="relative z-10 flex flex-col gap-2">
                                                <div className={`mb-1 ${config.mode === m.id ? 'opacity-100' : 'opacity-60'}`}><Icon name={m.icon} size={22} /></div>
                                                <div className="font-bold text-base tracking-tight">{m.label}</div>
                                            </div>
                                        </button>
                                    ))}
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 pt-4">
                                    <div className="space-y-4">
                                        <div className="flex justify-between items-center">
                                            <label className="text-xs font-bold text-zinc-400 dark:text-zinc-500 uppercase tracking-widest">Questions</label>
                                            <span className="text-sm font-bold text-zinc-900 dark:text-zinc-200 bg-zinc-100 dark:bg-zinc-800 px-2 py-1 rounded-md">{config.questionCount}</span>
                                        </div>
                                        <input type="range" min="5" max="200" step="5" value={config.questionCount} onChange={(e) => setConfig({...config, questionCount: parseInt(e.target.value)})} className="w-full h-2 bg-zinc-200 dark:bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-zinc-900 dark:accent-white" />
                                    </div>

                                    {config.mode === 'timed' && (
                                        <div className="space-y-4 animate-enter">
                                            <div className="flex justify-between items-center">
                                                <label className="text-xs font-bold text-zinc-400 dark:text-zinc-500 uppercase tracking-widest">Time (Min)</label>
                                                <span className="text-sm font-bold text-zinc-900 dark:text-zinc-200 bg-zinc-100 dark:bg-zinc-800 px-2 py-1 rounded-md">{config.duration}m</span>
                                            </div>
                                            <input type="range" min="5" max="120" step="5" value={config.duration} onChange={(e) => setConfig({...config, duration: parseInt(e.target.value)})} className="w-full h-2 bg-zinc-200 dark:bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-zinc-900 dark:accent-white" />
                                        </div>
                                    )}
                                </div>

                                <Button onClick={generateQuiz} disabled={!config.topic} className="w-full py-5 text-base mt-4">Initialize Session <Icon name="arrow-right" size={18} /></Button>
                            </div>
                        </div>
                    </div>
                </div>
            );

            const LoadingView = () => (
                <div className="flex flex-col items-center justify-center min-h-[60vh] animate-enter">
                    <div className="relative w-24 h-24 mb-10">
                        <div className="absolute inset-0 border-4 border-zinc-100 dark:border-zinc-800 rounded-full"></div>
                        <div className="absolute inset-0 border-4 border-zinc-900 dark:border-zinc-100 rounded-full border-t-transparent animate-spin"></div>
                        <div className="absolute inset-0 flex items-center justify-center animate-pulse"><Icon name="cpu" size={32} className="text-zinc-400" /></div>
                    </div>
                    <h2 className="text-2xl font-bold text-zinc-900 dark:text-white mb-3">Synthesizing</h2>
                    <p className="text-zinc-500 dark:text-zinc-400 font-medium">Generating {config.questionCount} items for <span className="text-zinc-900 dark:text-zinc-200">{config.topic}</span></p>
                    <div className="mt-12 space-y-3 w-72">
                        {[1,2,3].map(i => <div key={i} className="h-2 rounded-full shimmer-bg w-full opacity-60" style={{ animationDelay: `${i * 0.15}s` }}></div>)}
                    </div>
                </div>
            );

            const QuizView = () => {
                const currentQ = quizData[currentIndex];
                const progress = ((currentIndex) / quizData.length) * 100;

                return (
                    <div className="max-w-3xl mx-auto w-full px-6 pt-8 pb-32 animate-enter">
                        <div className="flex items-center justify-between mb-10 sticky top-4 z-20 bg-white/90 dark:bg-zinc-900/90 backdrop-blur-md p-4 rounded-2xl border border-zinc-100 dark:border-zinc-800 shadow-sm">
                            <button onClick={resetApp} className="text-zinc-400 hover:text-red-500 transition-colors flex items-center gap-2 text-sm font-medium"><Icon name="x" size={18} /> Abort</button>
                            <div className="flex items-center gap-6 text-sm font-mono font-medium text-zinc-500 dark:text-zinc-400">
                                {config.mode === 'timed' && <div className={`flex items-center gap-2 ${timeLeft < 60 ? 'text-red-500 animate-pulse' : ''}`}><Icon name="timer" size={16} /><span>{formatTime(timeLeft)}</span></div>}
                                <span>{String(currentIndex + 1).padStart(2, '0')} / {quizData.length}</span>
                            </div>
                        </div>

                        <div className="mb-10 px-2">
                            <h2 className="text-2xl md:text-3xl font-bold text-zinc-900 dark:text-zinc-100 leading-tight mb-8">{currentQ.question}</h2>
                            <div className="space-y-4">
                                {currentQ.options.map((opt, idx) => {
                                    const selected = answers[currentIndex] === idx;
                                    const correct = currentQ.correctAnswerIndex === idx;
                                    const revealed = config.mode === 'practice' && showExplanation;
                                    
                                    let style = "border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-900 text-zinc-700 dark:text-zinc-300 hover:border-zinc-400 dark:hover:border-zinc-600"; 
                                    if (selected) style = "border-zinc-900 dark:border-zinc-100 bg-gradient-to-r from-zinc-800 to-black dark:from-zinc-100 dark:to-white text-white dark:text-black shadow-xl scale-[1.01]";
                                    if (revealed) {
                                        if (correct) style = "border-emerald-500 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-900 dark:text-emerald-400";
                                        else if (selected && !correct) style = "border-red-300 bg-red-50 dark:bg-red-900/20 text-red-900 dark:text-red-400 opacity-75";
                                        else style = "opacity-50 grayscale border-zinc-100 dark:border-zinc-800";
                                    }

                                    return (
                                        <button
                                            key={idx}
                                            onClick={() => { if(view !== 'results' && !(config.mode === 'practice' && showExplanation)) { setAnswers(p => ({...p, [currentIndex]: idx})); if(config.mode === 'practice') setShowExplanation(true); }}}
                                            disabled={revealed}
                                            className={`w-full p-6 text-left rounded-xl border transition-all duration-300 flex items-center justify-between group relative overflow-hidden ${!selected && !revealed ? 'dark:hover-gradient-dark hover-gradient-light' : ''} ${style}`}
                                        >
                                            <div className="flex items-center gap-5 relative z-10">
                                                <span className={`w-8 h-8 rounded-lg border flex items-center justify-center text-xs font-bold shrink-0 ${selected ? 'border-transparent bg-white/20 text-current' : 'border-zinc-200 dark:border-zinc-700 text-zinc-400'}`}>{['A','B','C','D'][idx]}</span>
                                                <span className="text-base md:text-lg">{opt}</span>
                                            </div>
                                            <div className="relative z-10">
                                                {selected && !revealed && <Icon name="check" size={20} className="opacity-50" />}
                                                {revealed && correct && <Icon name="check-circle" size={20} className="text-emerald-600 dark:text-emerald-400" />}
                                                {revealed && selected && !correct && <Icon name="x-circle" size={20} className="text-red-500 dark:text-red-400" />}
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>

                        {showExplanation && config.mode === 'practice' && (
                            <div className="mb-12 p-8 bg-zinc-50 dark:bg-zinc-900/50 border border-zinc-200 dark:border-zinc-800 rounded-2xl animate-enter relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-1 h-full bg-zinc-900 dark:bg-zinc-100"></div>
                                <h4 className="flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-zinc-500 dark:text-zinc-400 mb-3"><Icon name="info" size={14} /> Analysis</h4>
                                <p className="text-zinc-800 dark:text-zinc-200 leading-relaxed text-lg">{currentQ.explanation}</p>
                            </div>
                        )}

                        <div className="fixed bottom-0 left-0 w-full bg-white/90 dark:bg-zinc-950/90 backdrop-blur-xl border-t border-zinc-200 dark:border-zinc-800 py-5 px-6 z-30 transition-colors duration-300">
                            <div className="max-w-3xl mx-auto flex items-center justify-between">
                                <div className="absolute top-0 left-0 h-[3px] bg-zinc-900 dark:bg-zinc-100 transition-all duration-500 ease-out" style={{ width: `${progress}%` }}></div>
                                <button onClick={() => { if(currentIndex > 0) { setCurrentIndex(c => c - 1); setShowExplanation(false); }}} disabled={currentIndex === 0} className="flex items-center gap-2 text-zinc-500 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100 disabled:opacity-20 transition-colors font-medium text-sm px-4 py-2"><Icon name="arrow-left" size={18} /> Prev</button>
                                {config.mode === 'practice' && !showExplanation && currentIndex < quizData.length - 1 ? <span className="hidden md:inline text-xs font-bold text-zinc-300 dark:text-zinc-600 uppercase tracking-widest animate-pulse">Waiting for input</span> : (
                                    <Button onClick={currentIndex === quizData.length - 1 ? finishTest : () => { setCurrentIndex(c => c + 1); setShowExplanation(false); }} className="px-8 py-3">{currentIndex === quizData.length - 1 ? 'Finish' : 'Next'} <Icon name={currentIndex === quizData.length - 1 ? 'flag' : 'arrow-right'} size={18} /></Button>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            const ResultsView = () => {
                const correct = Object.keys(answers).filter(k => answers[k] === quizData[k].correctAnswerIndex).length;
                const score = Math.round((correct / quizData.length) * 100);

                return (
                    <div className="max-w-2xl mx-auto w-full px-6 pt-20 text-center animate-enter pb-20">
                        <div className="mb-10 relative inline-block group cursor-default">
                             <div className="absolute inset-0 bg-zinc-100 dark:bg-zinc-800 rounded-full blur-xl opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
                             <svg className="w-48 h-48 transform -rotate-90 relative z-10">
                                <circle cx="96" cy="96" r="80" stroke="currentColor" strokeWidth="12" fill="transparent" className="text-zinc-100 dark:text-zinc-800" />
                                <circle cx="96" cy="96" r="80" stroke={score > 75 ? "currentColor" : score > 50 ? "#f59e0b" : "#ef4444"} strokeWidth="12" fill="transparent" strokeDasharray={502} strokeDashoffset={502 - (502 * score) / 100} className={`transition-all duration-1000 ease-out ${score > 75 ? 'text-zinc-900 dark:text-zinc-100' : ''}`} strokeLinecap="round" />
                            </svg>
                            <div className="absolute inset-0 flex flex-col items-center justify-center z-20">
                                <span className="text-5xl font-bold tracking-tighter text-zinc-900 dark:text-white">{score}%</span>
                                <span className="text-xs font-bold text-zinc-400 dark:text-zinc-500 uppercase tracking-widest mt-1">Accuracy</span>
                            </div>
                        </div>

                        <h2 className="text-3xl font-bold text-zinc-900 dark:text-white mb-3 tracking-tight">Session Complete</h2>
                        <p className="text-zinc-500 dark:text-zinc-400 mb-12 text-lg">You scored <strong className="text-zinc-900 dark:text-zinc-200">{correct}</strong> / <strong className="text-zinc-900 dark:text-zinc-200">{quizData.length}</strong>.</p>

                        <div className="grid grid-cols-2 gap-5 mb-12">
                            <Button variant="secondary" onClick={() => { setView('testing'); setCurrentIndex(0); setShowExplanation(true); }} className="py-4">Review</Button>
                            <Button onClick={resetApp} className="py-4">New Session</Button>
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex-grow flex flex-col">
                    {/* Toast Notification */}
                    {toast && (
                        <div className={`fixed top-6 left-1/2 transform -translate-x-1/2 z-[70] px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 animate-enter ${toast.type === 'error' ? 'bg-red-500 text-white' : 'bg-zinc-900 text-white dark:bg-white dark:text-zinc-900'}`}>
                            <Icon name={toast.type === 'error' ? 'alert-circle' : 'info'} size={20} />
                            <span className="font-medium text-sm">{toast.msg}</span>
                        </div>
                    )}

                    <nav className="py-6 px-6 md:px-8 flex justify-between items-center max-w-7xl mx-auto w-full z-40">
                        <div className="flex items-center gap-3 cursor-pointer group" onClick={resetApp}>
                            <div className="relative w-10 h-10 bg-zinc-900 dark:bg-white rounded-xl flex items-center justify-center overflow-hidden shadow-lg shadow-zinc-200 dark:shadow-zinc-900/50">
                                <div className="absolute inset-0 bg-gradient-to-br from-zinc-800 to-black dark:from-zinc-100 dark:to-zinc-300"></div>
                                <Icon name="zap" size={20} className="relative z-10 text-white dark:text-zinc-900" />
                            </div>
                            <div className="flex flex-col">
                                <span className="font-bold text-lg leading-none tracking-tight text-zinc-900 dark:text-white">FBLA</span>
                                <span className="text-[10px] font-bold tracking-[0.3em] text-zinc-400 dark:text-zinc-500">PREP</span>
                            </div>
                        </div>

                         <div className="flex items-center gap-4">
                             <button onClick={() => setFeedbackOpen(true)} className="hidden md:flex items-center gap-2 text-sm font-bold text-zinc-500 hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-white transition-colors">
                                <Icon name="message-square" size={16} /> Feedback
                             </button>
                             <button onClick={toggleTheme} className="w-10 h-10 rounded-full flex items-center justify-center text-zinc-500 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors">
                                <Icon name={theme === 'light' ? 'moon' : 'sun'} size={20} />
                             </button>
                             {user && !user.isAnonymous ? (
                                 <button onClick={() => setSidebarOpen(true)} className="w-10 h-10 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 flex items-center justify-center font-bold">
                                    {user.displayName ? user.displayName[0] : 'U'}
                                 </button>
                             ) : (
                                 <button onClick={handleLogin} className="px-4 py-2 bg-zinc-900 dark:bg-white text-white dark:text-black rounded-lg text-sm font-bold shadow-lg hover:opacity-90 transition-opacity flex items-center gap-2">
                                    <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                    {user ? "Guest (Sign In)" : "Login"}
                                 </button>
                             )}
                         </div>
                    </nav>

                    <Sidebar isOpen={sidebarOpen} onClose={() => setSidebarOpen(false)} user={user} history={history} onLoadTopic={(t) => { setConfig({...config, topic: t}); setSidebarOpen(false); }} />
                    
                    <Modal isOpen={feedbackOpen} onClose={() => setFeedbackOpen(false)} title="Send Feedback">
                        <textarea 
                            value={feedbackText}
                            onChange={(e) => setFeedbackText(e.target.value)}
                            className="w-full h-32 p-4 bg-zinc-50 dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-xl mb-4 outline-none focus:ring-2 focus:ring-zinc-900 dark:focus:ring-white resize-none dark:text-white"
                            placeholder="What can we improve?..."
                        />
                        <Button onClick={handleFeedbackSubmit} className="w-full py-3">Submit Feedback</Button>
                    </Modal>

                    <main className="flex-grow flex flex-col">
                        {view === 'landing' && <LandingView />}
                        {view === 'loading' && <LoadingView />}
                        {view === 'testing' && <QuizView />}
                        {view === 'results' && <ResultsView />}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>